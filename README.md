# Pluma

A self-hosted markdown editor with live preview, document encryption, and dark/light theme support.

## Features

- âœï¸ Real-time markdown preview with Milkdown editor
- ğŸ”’ Document encryption using AES-256-CBC
- ğŸ“ File and folder management
- ğŸ’¾ Auto-save functionality
- ğŸŒ™ Dark/light theme toggle
- ğŸ³ Docker-based deployment
- ğŸ” Secure secret management with Docker Secrets
- ğŸ’ª Production-ready with health checks and resource limits

## Quick Start

### Prerequisites

- Docker and Docker Compose installed on your system
- Linux, macOS, or Windows with WSL2

### Installation

1. Clone this repository:

   ```bash
   git clone <your-repo-url>
   cd pluma
   ```

2. Run the setup script:

   ```bash
   chmod +x setup.sh
   ./setup.sh
   ```

   This will:
   - Generate secure secrets for JWT and encryption
   - Build Docker containers
   - Start the application

3. Access the application:
   - Frontend: http://localhost:3000
   - Backend API: http://localhost:3001

### Manual Setup

If you prefer to set up manually:

1. Generate secrets:

   ```bash
   chmod +x setup-secrets.sh
   ./setup-secrets.sh
   ```

2. Build and start containers:

   ```bash
   docker-compose up -d --build
   ```

3. View logs:
   ```bash
   docker-compose logs -f
   ```

## Configuration

### Docker Secrets

The application uses Docker Secrets for secure credential management:

- `jwt_secret`: Used for JWT token signing (64 hex characters)
- `encryption_key`: Used for document encryption (64 hex characters)

These are automatically generated by `setup-secrets.sh` and stored in the `secrets/` directory.

**âš ï¸ IMPORTANT:** Never commit the `secrets/` directory to version control. Back up these files securely - losing the encryption key means losing access to encrypted documents.

### Environment Variables

For development without Docker, you can use `.env` file:

```env
JWT_SECRET=your-jwt-secret-here
ENCRYPTION_KEY=your-encryption-key-here
PORT=3001
```

## Usage

### First Time Setup

1. Open http://localhost:3000
2. Create your account (first user becomes admin)
3. Start creating documents!

### Managing Documents

- Click "New Document" to create a file
- Click "New Folder" to organize your documents
- Use the Plain/Live toggle to switch between editor and preview
- Documents auto-save after each edit
- Use the color picker to customize folder/file colors

### Theme Toggle

Click the moon/sun icon in the header to switch between dark and light themes.

## Backup and Restore

### Backup Your Data

Create a backup of your documents:

```bash
docker run --rm \
  -v pluma_pluma-data:/data \
  -v $(pwd)/backups:/backup \
  alpine tar czf /backup/pluma-backup-$(date +%Y%m%d-%H%M%S).tar.gz /data
```

### Restore from Backup

```bash
docker run --rm \
  -v pluma_pluma-data:/data \
  -v $(pwd)/backups:/backup \
  alpine sh -c "cd /data && tar xzf /backup/pluma-backup-YYYYMMDD-HHMMSS.tar.gz --strip 1"
```

**Don't forget to also backup your `secrets/` directory!**

## Development

### Local Development

1. Install dependencies:

   ```bash
   pnpm install
   ```

2. Set up environment variables in `.env`

3. Start backend:

   ```bash
   cd backend
   pnpm dev
   ```

4. Start frontend (in another terminal):
   ```bash
   pnpm dev
   ```

### Project Structure

```
pluma/
â”œâ”€â”€ src/                  # Frontend SolidJS application
â”‚   â”œâ”€â”€ components/       # Reusable UI components
â”‚   â”œâ”€â”€ routes/          # Page routes
â”‚   â””â”€â”€ app.tsx          # Main app component
â”œâ”€â”€ backend/             # Hono backend API
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ routes/      # API routes (auth, documents)
â”‚       â””â”€â”€ index.ts     # Server entry point
â”œâ”€â”€ public/              # Static assets
â”œâ”€â”€ secrets/             # Docker secrets (DO NOT COMMIT)
â””â”€â”€ docker-compose.yml   # Docker orchestration
```

## Security

- All documents are encrypted at rest using AES-256-CBC
- Passwords are hashed using bcrypt
- JWT tokens for authentication with 7-day expiration
- Docker Secrets for sensitive credentials
- Path sanitization to prevent directory traversal
- Health checks for container monitoring

## Troubleshooting

### Container Not Starting

Check logs:

```bash
docker-compose logs backend
docker-compose logs frontend
```

### Health Check Failing

Check backend health endpoint:

```bash
curl http://localhost:3001/api/health
```

### Lost Encryption Key

If you lose the encryption key, documents cannot be decrypted. Always maintain secure backups of:

- `secrets/encryption_key.txt`
- `secrets/jwt_secret.txt`
- Document data volume

### Regenerating Secrets

âš ï¸ Warning: This will invalidate all existing encrypted documents and sessions.

```bash
rm -rf secrets/
./setup-secrets.sh
docker-compose down
docker-compose up -d --build
```

## Roadmap

See [FUTURE_FEATURES.md](FUTURE_FEATURES.md) for planned features and improvements.

## Contributing

Contributions are welcome! Please open an issue or submit a pull request.

## License

MIT
